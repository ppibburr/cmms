#!/usr/bin/env ruby
$: << File.expand_path(File.join(File.dirname(__FILE__),'..','lib'))
$: << File.expand_path(File.join(File.dirname(__FILE__),'..', '..', 'render','lib'))

require 'sinatra'
require 'render'
require 'web/request'
require 'web/push'

def routes &b
  $routes[site=File.basename(File.dirname(caller[0].split(":")[0]))] = b  
end

Dir.glob('./sites/*/site.rb').each do |f|
  require f
end

get "/" do
  page("main", site: nil, request: request)
end

get "/:site" do
  page("main", site: site, request: request)
end

get "/:site/:page" do
  page(params[:page], site: params[:site], request: request).to_s
end

post "/:site/:page/render/:view" do
  view(params[:view], site: params[:site], request: request).to_s  
end

post "/:site/:page/:view/render" do
  view(params[:view], site: params[:site], request: request).render(JSON.parse(request.body.read)).to_s
end


